import express from 'express';
import https from 'https';
import twilio from 'twilio';
import 'dotenv/config';
import xlsx from 'xlsx';
import fs from 'fs';

const app = express();
const port = process.env.PORT;

// Add middleware to parse incoming POST data
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Configuration
const ULTRAVOX_API_KEY = process.env.ULTRAVOX_API_KEY
const ULTRAVOX_API_URL = 'https://api.ultravox.ai/api/calls';
const TWILIO_ACCOUNT_SID = process.env.TWILIO_ACCOUNT_SID;
const TWILIO_AUTH_TOKEN = process.env.TWILIO_AUTH_TOKEN;
const TWILIO_PHONE_NUMBER = process.env.TWILIO_NUMBER;

// Twilio Client
const client = twilio(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN);

// Load Excel Directory
const DRIVERS_DIRECTORY_PATH = './South_Carolina_Directory.xlsx';
let driverData = {};

// ** Function to Load Excel Data**
function loadDriverDirectory() {
    if (!fs.existsSync(DRIVERS_DIRECTORY_PATH)) {
        console.error("üö® Driver directory not found!");
        return;
    }

    const workbook = xlsx.readFile(DRIVERS_DIRECTORY_PATH);
    const sheetName = workbook.SheetNames[1];
    const sheet = xlsx.utils.sheet_to_json(workbook.Sheets[sheetName]);

    driverData = {};  // Reset

    sheet.forEach(row => {
        if (row["Phone Number"]) {  // Ensure phone number is present
            driverData[row["Phone Number"]] = {
                name: row["Name"] || "Driver",
                dbaName: row["DBA Name"] || "",
                usdot: row["USDOT"] || "Unknown",
                address: row["Address"] || "No address provided",
                phone: row["Phone Number"],
                fax: row["Fax"] || "N/A",
                email: row["Email"] || "No email provided",
                operationType: row["Carrier Operation Type"] || "Unknown",
                drivers: row["Drivers"] || "Unknown",
                equipment: row["Equipment"] || "Unknown"
            };
        }
    });

    console.log("‚úÖ Driver directory loaded successfully!");
}

// Load driver data at startup
loadDriverDirectory();

// **üîπ Function to Get Driver Info by Phone Number**
function getDriverInfo(phoneNumber) {
    return driverData[phoneNumber] || null;
}

function generateDynamicPrompt(driverInfo) {
    return `
    Truck Onboarding Call Agent Script
    Objective: Onboard truck drivers to the company by understanding their needs, discussing services, and setting them up for dispatch.

    1. Greeting & Introduction
    "Hello, good [morning/afternoon/evening], this is George from Odispatch Solutions. How are you doing today?"

    ${driverInfo ? `I see that you're operating under USDOT **${driverInfo.usdot}**, and your company name is **${driverInfo.dbaName || driverInfo.name}**.` : ''}

    ${driverInfo?.address ? `I see your business is located in **${driverInfo.address}**. Do you primarily haul within your state or across multiple states?` : ''}

    2. Identifying the Truck Type
    "Before we proceed, I‚Äôd like to understand a bit more about your truck. 
    ${driverInfo?.equipment ? `I see that you operate a **${driverInfo.equipment}**. Can you confirm that?` : 'Could you tell me what type of truck you have?'}"

    ${driverInfo?.equipment ? '' : `Dry Van? (48ft/53ft)
    Reefer? (48ft/53ft)
    Flatbed? (48ft/53ft) ‚Äì Do you have tools like tarps, straps, chains, binders, winch, or a ramp?
    Hotshot? (26ft/30ft/36ft/40ft) ‚Äì Do you have tools like tarps, straps, chains, binders, winch, or a ramp?
    Box-truck? (26ft) ‚Äì Do you have a lift gate, pallet jack, straps, or E-tracks?
    Power-only?`}

    ${driverInfo?.operationType ? `I see that you operate as a **${driverInfo.operationType}** carrier. Do you usually work locally (inside the state) or OTR (On The Road)?` : 'Do you usually work locally (inside the state) or OTR (On The Road)?'}

    ${driverInfo?.email ? `I see you‚Äôve used the email **${driverInfo.email}**. Can I send your sign-up link there?` : 'Can you provide your email for registration?'}

    3. Dispatcher Inquiry
    "Have you worked with a dispatcher before?"
    
    ${driverInfo?.dispatcher ? `I see that you've worked with a dispatcher before. Were you satisfied with their service?` : `"We offer a comprehensive dispatch service that ensures you get access to high-paying loads, and we handle all the paperwork, negotiations, and compliance for you."`}

    4. Rates & Service Benefits
    "Our rates depend on the size of your truck, but the best part is:"

    ‚úÖ No contract obligation ‚Äì You can stop working with us anytime.
    ‚úÖ No Load, No Fee ‚Äì If you don‚Äôt book a load, we don‚Äôt charge you.
    ‚úÖ You approve every load ‚Äì No loads will be booked without your consent.
    ‚úÖ We handle all paperwork, including:
       - Carrier setup
       - TONU (Truck Order Not Used)
       - Detention management
       - IFTA filing
       - DOT compliance
       - Invoicing

    ‚úÖ Dedicated Dispatchers ‚Äì Experienced professionals will negotiate and book high-paying loads for you.
    ‚úÖ We only charge 7% of the load.

    "Would you be interested in signing up with us?"

    5. Setting Up the Driver
    "Signing up is easy! I will send you a signup link via text and email."

    ${driverInfo?.email ? `I have your email as **${driverInfo.email}**. Can I send the signup link there?` : "Can you confirm your email address so we can send you the signup link?"}

    üì© Once you receive the email, please reply with the following documents:
    1Ô∏è‚É£ MC Certificate
    2Ô∏è‚É£ W9 Form
    3Ô∏è‚É£ Certificate of Insurance (COI)
    4Ô∏è‚É£ Notice of Assignment (if factoring)
    5Ô∏è‚É£ Driver‚Äôs License
    6Ô∏è‚É£ Cab Card Registration

    "After you send these documents, we will finalize your setup, and you‚Äôll be ready to receive loads."

    6. Handling Load Requests (If the Driver Asks for a Load Immediately)
    "Absolutely! Let me check for loads in your area. 
    ${driverInfo?.address ? `I see that you‚Äôre located in **${driverInfo.address}**. What‚Äôs your current ZIP code?` : 'What‚Äôs your current ZIP code?'}"

    üìå Example Load:
    - Deadhead Miles: **[Random between 50-150 miles]**
    - Total Distance: **[Random between 300-1500 miles]**
    - Load Weight: **[Random between 20,000 - 45,000 lbs]**
    - Rate: **[$2.50 - $3.50 per mile, based on truck type]**

    "Would you like me to proceed with onboarding you so we can start booking these loads for you?"

    7. Closing
    "I appreciate your time today! I‚Äôll send the signup link and follow up with you shortly."
    
    "If you have any questions, feel free to reach out. Looking forward to working with you!"
    `;
}

// // Ultravox configuration
// const SYSTEM_PROMPT = `Truck Onboarding Call Agent Script
// Objective: Onboard truck drivers to the company by understanding their needs, discussing services, and setting them up for dispatch.

// 1. Greeting & Introduction
// Agent:
// "Hello, good [morning/afternoon/evening], this is [Your Name] from Odispatch Solutions. How are you doing today?"

// (Pause for response)

// "We are a freight management company, and we have multiple loads available. Right now, we are looking for dedicated carriers to cover these loads. I wanted to check if you‚Äôd be interested in working with us."

// 2. Identifying the Truck Type
// "Before we proceed, I‚Äôd like to understand a bit more about your truck. Could you tell me what type of truck you have?"

// (Wait for response, then clarify details using the following prompts:)

// Dry Van? (48ft/53ft)
// Reefer? (48ft/53ft)
// Flatbed? (48ft/53ft) ‚Äì Do you have tools like tarps, straps, chains, binders, winch, or a ramp?
// Hotshot? (26ft/30ft/36ft/40ft) ‚Äì Do you have tools like tarps, straps, chains, binders, winch, or a ramp?
// Box-truck? (26ft) ‚Äì Do you have a lift gate, pallet jack, straps, or E-tracks?
// Power-only?
// "Also, what are your truck‚Äôs weight capacity and other key specifications? Do you have a Hazmat certificate or TWIC card?"

// "Do you usually work locally (inside the state), or are you on the road (OTR)?"

// 3. Dispatcher Inquiry
// "Have you worked with a dispatcher before?"

// If Yes:
// "Are you satisfied with their services?"

// If No: "What services do you think we can offer you to make your experience better?"
// If No Dispatcher:
// "We offer a comprehensive dispatch service that ensures you get access to high-paying loads, and we handle all the paperwork, negotiations, and compliance for you."

// 4. Rates & Service Benefits
// "Our rates depend on the size of your truck, but the best part is:"

// No contract obligation ‚Äì You can stop working with us anytime.
// No Load, No Fee ‚Äì If you don‚Äôt book a load, we don‚Äôt charge you.
// You approve every load ‚Äì No loads will be booked without your consent.
// We handle all paperwork, including:
// Carrier setup
// TONU (Truck Order Not Used)
// Detention management
// IFTA filing
// DOT compliance
// Invoicing
// Dedicated Dispatchers ‚Äì Experienced professionals will negotiate and book high-paying loads for you.
// We only charge 7% of the load.
// "Would you be interested in signing up with us?"

// 5. Setting Up the Driver
// "Signing up is easy! I will send you a signup link via text and email. Can you confirm your email address?"

// "Once you receive the email, please reply with the following documents:"

// MC Certificate
// W9 Form
// Certificate of Insurance (COI)
// Notice of Assignment (if factoring)
// Driver‚Äôs License
// Cab Card Registration
// "After you send these documents, we will finalize your setup, and you‚Äôll be ready to receive loads."

// 6. Handling Load Requests (If the Driver Asks for a Load Immediately)
// "Absolutely! Let me check for loads in your area. What‚Äôs your current ZIP code?"

// (Agent provides a fake load option based on ZIP code.)

// Example:
// "I see a load available near you. Here are the details:"

// Deadhead Miles: [Random between 50-150 miles]
// Total Distance: [Random between 300-1500 miles]
// Load Weight: [Random between 20,000 - 45,000 lbs]
// Rate: [$2.50 - $3.50 per mile, based on truck type]
// "Would you like me to proceed with onboarding you so we can start booking these loads for you?"

// 7. Closing
// "I appreciate your time today! I‚Äôll send the signup link and follow up with you shortly. If you have any questions, feel free to reach out. Looking forward to working with you!"`;

const ULTRAVOX_CALL_CONFIG = {
    // systemPrompt: SYSTEM_PROMPT,
    model: 'fixie-ai/ultravox',
    voice: 'Conversationalist-English',
    // voice: 'Anjali-Hindi-Urdu',
    temperature: 0.3,
    firstSpeaker: 'FIRST_SPEAKER_AGENT',
    medium: { "twilio": {} }
};

// Create Ultravox call and get join URL
async function createUltravoxCall(config = ULTRAVOX_CALL_CONFIG) {
    const request = https.request(ULTRAVOX_API_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': ULTRAVOX_API_KEY
        }
    });

    return new Promise((resolve, reject) => {
        let data = '';

        request.on('response', (response) => {
            response.on('data', chunk => data += chunk);
            response.on('end', () => {
                try {
                    console.log('Ultravox Raw Response:', data); // Log full response
                    const jsonResponse = JSON.parse(data);
                    
                    if (!jsonResponse.joinUrl) {
                        console.error('Missing joinUrl in Ultravox response:', jsonResponse);
                        return reject(new Error('Ultravox API response missing joinUrl'));
                    }

                    resolve(jsonResponse);
                } catch (error) {
                    console.error('Error parsing Ultravox response:', error);
                    reject(error);
                }
            });
        });

        request.on('error', (error) => {
            console.error('Ultravox API request error:', error);
            reject(error);
        });

        request.write(JSON.stringify(config));
        request.end();
    });
}


// Handle incoming calls
app.post('/incoming', async (req, res) => {
    try {
        // Get caller's phone number
        const callerNumber = req.body.From;
        console.log(`Incoming call from: ${callerNumber}`);

        // const driverInfo = getDriverInfo(callerNumber);
        // if (driverInfo) {
        //     console.log(`üîé Found driver details:`, driverInfo);
        // } else {
        //     console.log("üö® No matching driver found in the directory.");
        // }

        // Create dynamic system prompt with caller's number
//         const dynamicSystemPrompt = `üöõ ‡§ü‡•ç‡§∞‡§ï ‡§ë‡§®‡§¨‡•ã‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§ï‡•â‡§≤ ‡§è‡§ú‡•á‡§Ç‡§ü ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü (‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§ï‡§∞‡§£ + ‡§∏‡§ø‡§∞‡•ç‡§´ ‡§â‡§∞‡•ç‡§¶‡•Ç ‡§∂‡§¨‡•ç‡§¶)
// (‡§è‡§Ü‡§à ‡§ï‡•ã ‡§ú‡§µ‡§æ‡§¨ ‡§≠‡•Ä ‡§á‡§∏‡•Ä ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è ‡§§‡§æ‡§ï‡§ø ‡§Ø‡§π ‡§®‡•à‡§ö‡•Å‡§∞‡§≤ ‡§≤‡§ó‡•á ‡§î‡§∞ ‡§è‡§Ü‡§à ‡§°‡§ø‡§ü‡•á‡§ï‡•ç‡§ü ‡§® ‡§π‡•ã ‡§∏‡§ï‡•á‡•§ ‡§ú‡§µ‡§æ‡§¨ ‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂ ‡§î‡§∞ ‡§â‡§∞‡•ç‡§¶‡•Ç ‡§Æ‡§ø‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§Ç‡§ó‡•á‡•§)

// 1Ô∏è‚É£ ‡§á‡§¨‡•ç‡§§‡§ø‡§¶‡§æ‡§à ‡§¨‡§æ‡§§-‡§ö‡•Ä‡§§ (Greeting & Introduction)
// ‡§è‡§ú‡•á‡§Ç‡§ü:
// "‡§π‡•à‡§≤‡•ã, ‡§Æ‡•à‡§Ç Ali ‡§¨‡§æ‡§§ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç ‡§ì‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö ‡§∏‡•â‡§≤‡•ç‡§Ø‡•Ç‡§∂‡§Ç‡§∏ ‡§∏‡•á‡•§ ‡§Ü‡§™ ‡§ï‡•à‡§∏‡•á ‡§π‡•à‡§Ç?"

// (‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§∞‡•Å‡§ï ‡§ï‡§∞, ‡§ú‡§µ‡§æ‡§¨ ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•ã‡•§)

// "‡§π‡§Æ ‡§è‡§ï Freight management ‡§ï‡§Ç‡§™‡§®‡•Ä ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ multiple loads available ‡§π‡•à‡§Ç‡•§ ‡§Ö‡§≠‡•Ä ‡§π‡§Æ dedicated carriers dhoond  ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§Ø‡•á ‡§≤‡•ã‡§° ‡§≤‡•á ‡§∏‡§ï‡•á‡§Ç‡•§ ‡§ï‡§ø‡§Ø‡§æ ‡§Ü‡§™ interrested  ‡§π‡•à‡§Ç?
// "

// 2Ô∏è‚É£ ‡§ü‡•ç‡§∞‡§ï ‡§ï‡•Ä ‡§§‡§´‡§º‡§∏‡•Ä‡§≤‡§æ‡§§ (Identifying the Truck Type)
// "‡§Ü‡§ó‡•á ‡§¨‡•ù‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á, ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§ü‡•ç‡§∞‡§ï se related ‡§ï‡•Å‡§õ information  ‡§≤‡•á‡§®‡§æ ‡§ö‡§æ‡§π‡•Ç‡§Ç‡§ó‡§æ‡•§ ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ï‡§ø‡§∏ ‡§ï‡§ø‡§∏‡•ç‡§Æ ‡§ï‡§æ ‡§ü‡•ç‡§∞‡§ï ‡§π‡•à?"

// (‡§•‡•ã‡•ú‡•Ä ‡§¶‡•á‡§∞ Ruko ÿå ‡§ú‡§µ‡§æ‡§¨ suno ‡§î‡§∞ ‡§´‡§ø‡§∞ yeh options dein:)

// ‡§°‡•ç‡§∞‡§æ‡§à ‡§µ‡•à‡§®? (48ft/53ft)
// ‡§∞‡•Ä‡§´‡§∞? (48ft/53ft)
// ‡§´‡•ç‡§≤‡•à‡§ü‡§¨‡•á‡§°? (48ft/53ft) ‚Äì ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ü‡§æ‡§∞‡•ç‡§™‡•ç‡§∏, ‡§∏‡•ç‡§ü‡•ç‡§∞‡•à‡§™‡•ç‡§∏, ‡§ö‡•á‡§®, ‡§¨‡§æ‡§á‡§Ç‡§°‡§∞‡•ç‡§∏, ‡§µ‡§ø‡§Ç‡§ö ‡§Ø‡§æ ‡§∞‡•à‡§Ç‡§™ ‡§π‡•à?
// ‡§π‡•â‡§ü‡§∂‡•â‡§ü? (26ft/30ft/36ft/40ft) ‚Äì ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ü‡§æ‡§∞‡•ç‡§™‡•ç‡§∏, ‡§∏‡•ç‡§ü‡•ç‡§∞‡•à‡§™‡•ç‡§∏, ‡§ö‡•á‡§®, ‡§¨‡§æ‡§á‡§Ç‡§°‡§∞‡•ç‡§∏, ‡§µ‡§ø‡§Ç‡§ö ‡§Ø‡§æ ‡§∞‡•à‡§Ç‡§™ ‡§π‡•à?
// ‡§¨‡•â‡§ï‡•ç‡§∏-‡§ü‡•ç‡§∞‡§ï? (26ft) ‚Äì ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§≤‡§ø‡§´‡§º‡•ç‡§ü ‡§ó‡•á‡§ü, ‡§™‡•à‡§≤‡•á‡§ü ‡§ú‡•à‡§ï, ‡§∏‡•ç‡§ü‡•ç‡§∞‡•à‡§™‡•ç‡§∏ ‡§Ø‡§æ ‡§à-‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§∏ ‡§π‡•à‡§Ç?
// ‡§™‡§æ‡§µ‡§∞-‡§ì‡§®‡§≤‡•Ä?
// "‡§î‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§ü‡•ç‡§∞‡§ï ‡§ï‡•Ä ‡§µ‡§ú‡§º‡§® ‡§ï‡•à‡§™‡•á‡§∏‡§ø‡§ü‡•Ä ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? ‡§ï‡•ã‡§à ‡§ñ‡§º‡§æ‡§∏ ‡§∏‡§∞‡•ç‡§ü‡§ø‡§´‡§º‡§ø‡§ï‡•á‡§∂‡§® ‡§ú‡•à‡§∏‡•á ‡§π‡§ú‡§º‡§Æ‡§§ ‡§Ø‡§æ TWIC ‡§ï‡§æ‡§∞‡•ç‡§° ‡§π‡•à?"

// "‡§Ü‡§™ ‡§∏‡§ø‡§∞‡•ç‡§´‡§º ‡§Æ‡§ï‡§º‡§æ‡§Æ‡•Ä (‡§∏‡•ç‡§ü‡•á‡§ü ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞) ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ ‡§≤‡§Ç‡§¨‡§æ ‡§∏‡§´‡§º‡§∞ (OTR) ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç?"

// 3Ô∏è‚É£ ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö‡§∞ ‡§ï‡§æ ‡§§‡§ú‡•Å‡§∞‡•ç‡§¨‡§æ (Dispatcher Inquiry)
// "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡§æ‡§Æ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à?"

// ‚úÖ ‡§Ö‡§ó‡§∞ ‡§π‡§æ‡§Ç:
// "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§â‡§®‡§ï‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§∏‡•á Khush ‡§π‡•à‡§Ç?"

// ‚ùå ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç:
// "‡§Ü‡§™‡§ï‡•ã Udhr kya problems ‡§π‡•à‡§Ç?

// üìå ‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§ï‡•á ‡§™‡§æ‡§∏ ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à:
// "‡§π‡§Æ ‡§è‡§ï ‡§Æ‡•Å‡§ï‡§Æ‡•ç‡§Æ‡§≤ ‡§°‡§ø‡§∏‡§™‡•à‡§ö ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ provide ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡•ã ‡§Ü‡§™‡§ï‡•ã ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§∞‡•á‡§ü‡•ç‡§∏ ‡§™‡§∞ ‡§π‡§æ‡§à Paying ‡§≤‡•ã‡§°‡§∏ ‡§¶‡§ø‡§≤‡§µ‡§æ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ ‡§∏‡§æ‡§∞‡•Ä ‡§™‡•á‡§™‡§∞ ‡§µ‡§∞‡•ç‡§ï,dealing ‡§î‡§∞ complains ‡§π‡§Æ ‡§∏‡§Å‡§≠‡§æ‡§≤‡§§‡•á ‡§π‡•à‡§Ç‡•§"

// 4Ô∏è‚É£ ‡§∞‡•á‡§ü‡•ç‡§∏ ‡§î‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§ï‡•á ‡§´‡§º‡§æ‡§Ø‡§¶‡•á (Rates & Service Benefits)
// "‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∞‡•á‡§ü ‡§ü‡•ç‡§∞‡§ï ‡§ï‡•á ‡§∏‡§æ‡§á‡§ú ‡§™‡§∞ ‡§Æ‡§¨‡§®‡•Ä ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§∏‡§¨‡§∏‡•á ‡§¨‡•á‡§π‡§§‡§∞‡•Ä‡§® ‡§¨‡§æ‡§§ ‡§Ø‡•á ‡§π‡•à:"

// ‚úÖ ‡§ï‡•ã‡§à ‡§ï‡•â‡§®‡•ç‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‚Äì ‡§Ü‡§™ ‡§ú‡§¨ ‡§ö‡§æ‡§π‡•á‡§Ç ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
// ‚úÖ ‡§®‡•ã ‡§≤‡•ã‡§°, ‡§®‡•ã ‡§´‡§º‡•Ä‡§∏ ‚Äì ‡§Ö‡§ó‡§∞ ‡§Ü‡§™ ‡§≤‡•ã‡§° ‡§¨‡•Å‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡•á, ‡§§‡•ã ‡§π‡§Æ ‡§ï‡•ã‡§à ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•á‡§Ç‡§ó‡•á‡•§
// ‚úÖ ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§Ç‡§ú‡§º‡•Ç‡§∞‡•Ä ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à ‚Äì ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§∞‡§ú‡§º‡•Ä ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§¨‡•Å‡§ï ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ‡•§
// ‚úÖ ‡§π‡§Æ ‡§∏‡§æ‡§∞‡•Ä ‡§™‡•á‡§™‡§∞‡§µ‡§∞‡•ç‡§ï ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡•á ‡§π‡•à‡§Ç, ‡§ú‡•à‡§∏‡•á:

// üìú ‡§ï‡•à‡§∞‡•Ä‡§Ø‡§∞ ‡§∏‡•á‡§ü‡§Ö‡§™
// üìú TONU (‡§ü‡•ç‡§∞‡§ï ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§®‡•â‡§ü ‡§Ø‡•Ç‡§ú‡§º‡•ç‡§°)
// üìú ‡§°‡§ø‡§ü‡•á‡§Ç‡§∂‡§® ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü
// üìú IFTA ‡§´‡§º‡§æ‡§á‡§≤‡§ø‡§Ç‡§ó
// üìú DOT ‡§ï‡§Ç‡§™‡•ç‡§≤‡§æ‡§á‡§Ö‡§®‡•ç‡§∏
// üìú ‡§á‡§®‡§µ‡•â‡§á‡§∏‡§ø‡§Ç‡§ó

// ‚úÖ ‡§Æ‡•Å‡§ï‡§º‡§∞‡•ç‡§∞‡§∞ ‡§°‡§ø‡§∏‡•ç‡§™‡•à‡§ö‡§∞‡•ç‡§∏ ‚Äì ‡§ú‡•ã ‡§π‡§æ‡§à-‡§™‡•á‡§á‡§Ç‡§ó ‡§≤‡•ã‡§°‡•ç‡§∏ ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§
// ‚úÖ ‡§∏‡§ø‡§∞‡•ç‡§´‡§º 7% ‡§™‡§∞ ‡§≤‡•ã‡§° ‡§ö‡§æ‡§∞‡•ç‡§ú ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§

// "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∏‡§æ‡§• ‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á?"

// 5Ô∏è‚É£ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§ï‡§æ ‡§∏‡•á‡§ü‡§Ö‡§™ (Setting Up the Driver)
// "‡§∏‡§æ‡§á‡§®-‡§Ö‡§™ ‡§¨‡§π‡•Å‡§§ ‡§Ü‡§∏‡§æ‡§® ‡§π‡•à! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§≤‡§ø‡§Ç‡§ï ‡§Ö‡§≠‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§î‡§∞ ‡§à‡§Æ‡•á‡§≤ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ö‡§™‡§®‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç?"

// üìå ‡§ú‡§¨ ‡§Ü‡§™‡§ï‡•ã ‡§à‡§Æ‡•á‡§≤ ‡§Æ‡§ø‡§≤ ‡§ú‡§æ‡§è, ‡§§‡•ã ‡§Ø‡•á ‡§°‡•â‡§ï‡•ç‡§Ø‡•Å‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§´‡§º‡§∞‡§æ‡§π‡§Æ ‡§ï‡§∞‡•á‡§Ç:

// üìÑ MC ‡§∏‡§∞‡•ç‡§ü‡§ø‡§´‡§º‡§ø‡§ï‡•á‡§ü
// üìÑ W9 ‡§´‡§º‡•â‡§∞‡•ç‡§Æ
// üìÑ ‡§á‡§Ç‡§∂‡•ç‡§Ø‡•ã‡§∞‡•á‡§Ç‡§∏ ‡§ï‡§æ ‡§∏‡§∞‡•ç‡§ü‡§ø‡§´‡§º‡§ø‡§ï‡•á‡§ü (COI)
// üìÑ ‡§®‡•ã‡§ü‡§ø‡§∏ ‡§ë‡§´‡§º ‡§Ö‡§∏‡§æ‡§á‡§®‡§Æ‡•á‡§Ç‡§ü (‡§Ö‡§ó‡§∞ ‡§´‡§º‡•à‡§ï‡•ç‡§ü‡§∞‡§ø‡§Ç‡§ó ‡§Ø‡•Ç‡§ú‡§º ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç)
// üìÑ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§ï‡§æ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏
// üìÑ ‡§ï‡•à‡§¨ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§®

// "‡§ú‡§¨ ‡§Ø‡•á ‡§∏‡§¨ ‡§°‡•â‡§ï‡•ç‡§Ø‡•Å‡§Æ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≤ ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á, ‡§§‡•ã ‡§π‡§Æ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§Æ‡•Å‡§ï‡§Æ‡•ç‡§Æ‡§≤ ‡§ï‡§∞ ‡§¶‡•á‡§Ç‡§ó‡•á ‡§î‡§∞ ‡§Ü‡§™ ‡§≤‡•ã‡§°‡•ç‡§∏ ‡§â‡§†‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã‡§Ç‡§ó‡•á‡•§"

// 6Ô∏è‚É£ ‡§Ö‡§ó‡§∞ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§≤‡•ã‡§° ‡§Æ‡§æ‡§Ç‡§ó‡§§‡§æ ‡§π‡•à (Handling Load Requests If Driver Asks for a Load Immediately)
// "‡§¨‡§ø‡§≤‡§ï‡•Å‡§≤ ‡§≠‡§æ‡§à! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•á ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§ö‡•á‡§ï ‡§ï‡§∞‡§§‡§æ ‡§π‡•Ç‡§Ç‡•§ ‡§Ü‡§™‡§ï‡§æ ZIP ‡§ï‡•ã‡§° ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?"

// (‡§è‡§Ü‡§à ‡§è‡§ú‡•á‡§Ç‡§ü ZIP ‡§ï‡•ã‡§° ‡§ï‡•á ‡§Æ‡•Å‡§§‡§æ‡§¨‡§ø‡§ï‡§º ‡§è‡§ï ‡§∞‡•à‡§Ç‡§°‡§Æ ‡§≤‡•ã‡§° ‡§∏‡§ú‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§ó‡§æ‡•§)

// üìç ‡§°‡•á‡§¢‡§º‡§π‡•á‡§° ‡§Æ‡§æ‡§á‡§≤‡•ç‡§∏: [50-150 ‡§Æ‡§æ‡§á‡§≤‡•ç‡§∏]
// üöõ ‡§ï‡•Å‡§≤ ‡§´‡§æ‡§∏‡§≤‡§æ: [300-1500 ‡§Æ‡§æ‡§á‡§≤‡•ç‡§∏]
// ‚öñÔ∏è ‡§≤‡•ã‡§° ‡§µ‡§ú‡§º‡§®: [20,000 - 45,000 lbs]
// üí≤ ‡§∞‡•á‡§ü: [$2.50 - $3.50 ‡§™‡§∞ ‡§Æ‡§æ‡§á‡§≤, ‡§ü‡•ç‡§∞‡§ï ‡§ï‡§º‡§ø‡§∏‡•ç‡§Æ ‡§ï‡•á ‡§Æ‡•Å‡§§‡§æ‡§¨‡§ø‡§ï‡§º]

// "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ö‡§æ‡§π‡•á‡§Ç‡§ó‡•á ‡§ï‡§ø ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§ë‡§®‡§¨‡•ã‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§Æ‡•Å‡§ï‡§Æ‡•ç‡§Æ‡§≤ ‡§ï‡§∞‡•Ç‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§π‡§Æ ‡§Ø‡•á ‡§≤‡•ã‡§°‡•ç‡§∏ ‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡•Å‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç?"

// 7Ô∏è‚É£ ‡§ó‡•Å‡§´‡§º‡•ç‡§§‡§ó‡•Ç ‡§ï‡§æ ‡§á‡§ñ‡§º‡•ç‡§§‡§ø‡§§‡§æ‡§Æ (Closing)
// "‡§≠‡§æ‡§à, ‡§Ü‡§™‡§ï‡•á ‡§µ‡§ï‡§º‡•ç‡§§ ‡§ï‡§æ ‡§∂‡•Å‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ! ‡§Æ‡•à‡§Ç ‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§≤‡§ø‡§Ç‡§ï ‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç ‡§î‡§∞ ‡§Ü‡§™‡§∏‡•á ‡§ú‡§≤‡•ç‡§¶ ‡§´‡§º‡•â‡§≤‡•ã-‡§Ö‡§™ ‡§ï‡§∞‡•Ç‡§Ç‡§ó‡§æ‡•§ ‡§Ö‡§ó‡§∞ ‡§ï‡•ã‡§à ‡§∏‡§µ‡§æ‡§≤ ‡§π‡•ã ‡§§‡•ã ‡§¨‡§ø‡§®‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§ù‡§ø‡§ù‡§ï ‡§ï‡•á ‡§¨‡§§‡§æ ‡§¶‡•Ä‡§ú‡§ø‡§è‡•§ ‡§Ü‡§™‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§∞‡§π‡•á‡§ó‡§æ!"

// ‚úÖ IMPORTANT NOTES:
// üöÄ ‡§è‡§Ü‡§à ‡§ï‡•á ‡§ú‡§µ‡§æ‡§¨ ‡§≠‡•Ä ‡§á‡§∏‡•Ä ‡§´‡§º‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è‡•§
// üó£ ‡§ó‡•Å‡§´‡§º‡•ç‡§§‡§ó‡•Ç ‡§¨‡§ø‡§≤‡•ç‡§ï‡•Å‡§≤ ‡§®‡•à‡§ö‡•Å‡§∞‡§≤ ‡§≤‡§ó‡•á, ‡§ú‡•à‡§∏‡•á ‡§è‡§ï ‡§π‡§ï‡§º‡•Ä‡§ï‡§º‡•Ä ‡§∂‡§ñ‡§º‡•ç‡§∏ ‡§¨‡§æ‡§§ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•ã‡•§
// üîÑ ‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂ ‡§î‡§∞ ‡§â‡§∞‡•ç‡§¶‡•Ç ‡§ï‡§æ ‡§¨‡•à‡§≤‡•á‡§Ç‡§∏‡•ç‡§° ‡§Æ‡§ø‡§ï‡•ç‡§∏ ‡§π‡•ã, ‡§§‡§æ‡§ï‡§ø ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡•ã ‡§Ø‡•á ‡§® ‡§≤‡§ó‡•á ‡§ï‡§ø ‡§è‡§Ü‡§à ‡§¨‡•ã‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à‡•§
// `;
        
        // Create an Ultravox call with dynamic prompt
        const callConfig = {
            ...ULTRAVOX_CALL_CONFIG,
            systemPrompt: SYSTEM_PROMPT
        };

        // Create Ultravox call with updated config
        const { joinUrl } = await createUltravoxCall(callConfig);
        console.log(`Ultravox joined: ${joinUrl}`);

        const twiml = new twilio.twiml.VoiceResponse();
        const connect = twiml.connect();
        connect.stream({
            url: joinUrl,
            name: 'ultravox'
        });

        const twimlString = twiml.toString();
        res.type('text/xml');
        res.send(twimlString);

    } catch (error) {
        console.error('Error handling incoming call:', error);
        const twiml = new twilio.twiml.VoiceResponse();
        twiml.say('Sorry, there was an error connecting your call.');
        res.type('text/xml');
        res.send(twiml.toString());
    }
});

let callQueue = Object.keys(driverData); // Store phone numbers from the directory
let lastCalledIndex = 0; // Keep track of the last called driver
// **üîπ Outbound Call Functionality**
app.post('/outbound', async (req, res) => {
    try {
        if (callQueue.length === 0) {
            return res.status(400).json({ error: 'No drivers available in the directory.' });
        }

        // // Get the next driver in the list
        const to = callQueue[lastCalledIndex];
        lastCalledIndex = (lastCalledIndex + 1) % callQueue.length; // Loop through the list
        // const to = req.body.to;
        console.log(`üìû Initiating outbound call to: ${to}`);

        const driverInfo = getDriverInfo(to);
        if (driverInfo) {
            console.log(`üîé Found driver details:`, driverInfo);
        } else {
            console.log("üö® No matching driver found in the directory.");
            return res.status(400).json({ error: 'Driver not found.' });
        }

        // **Dynamic Prompt Using Driver Data**
        const dynamicSystemPrompt = generateDynamicPrompt(driverInfo);
        // console.log(dynamicSystemPrompt);

        // Create Ultravox call to generate AI conversation
        const callConfig = {
            ...ULTRAVOX_CALL_CONFIG,
            systemPrompt: dynamicSystemPrompt
        };

        const { joinUrl } = await createUltravoxCall(callConfig);

        // Initiate Twilio outbound call
        const call = await client.calls.create({
            url: `${process.env.APP_PUBLIC_URL}/twiml?joinUrl=${encodeURIComponent(joinUrl)}`, // TwiML instruction URL
            to,
            from: TWILIO_PHONE_NUMBER
        });

        console.log(`Outbound call initiated: ${call.sid}`);
        res.json({ message: 'Call initiated successfully', callSid: call.sid });

    } catch (error) {
        console.error('Error initiating outbound call:', error);
        res.status(500).json({ error: 'Failed to initiate call' });
    }
});

// Twilio Webhook for handling TwiML (for outbound calls)
app.all('/twiml', (req, res) => {
    try {
        const { joinUrl } = req.query;

        if (!joinUrl) {
            return res.status(400).send('Missing joinUrl');
        }

        const twiml = new twilio.twiml.VoiceResponse();
        const connect = twiml.connect();
        connect.stream({
            url: joinUrl,
            name: 'ultravox'
        });

        res.type('text/xml');
        res.send(twiml.toString());
    } catch (error) {
        console.error('Error handling TwiML:', error);
        res.status(500).send('Internal Server Error');
    }
});

// Start server
app.listen(port, () => {
    console.log(`Server running on port ${port}`);
});